<?xml version="1.0" encoding="UTF-8"?>
<mule xmlns="http://www.mulesource.org/schema/mule/core/2.2"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:spring="http://www.springframework.org/schema/beans"
       xmlns:vm="http://www.mulesource.org/schema/mule/vm/2.2"
       xmlns:http="http://www.mulesource.org/schema/mule/http/2.2"
       xmlns:restlet="http://www.mulesource.org/schema/mule/restlet/2.2"
       xmlns:json="http://www.mulesource.org/schema/mule/json/2.2"
       xmlns:context="http://www.springframework.org/schema/context"
    xsi:schemaLocation="
       http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
       http://www.mulesource.org/schema/mule/core/2.2 http://www.mulesource.org/schema/mule/core/2.2/mule.xsd
       http://www.mulesource.org/schema/mule/vm/2.2 http://www.mulesource.org/schema/mule/vm/2.2/mule-vm.xsd
       http://www.mulesource.org/schema/mule/http/2.2 http://www.mulesource.org/schema/mule/http/2.2/mule-http.xsd
       http://www.mulesource.org/schema/mule/restlet/2.2 http://www.mulesource.org/schema/mule/restlet/2.2/mule-restlet.xsd
       http://www.mulesource.org/schema/mule/json/2.2 http://www.mulesource.org/schema/mule/json/2.2/mule-json.xsd
       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-2.5.xsd">

	<configuration defaultSynchronousEndpoints="true" defaultResponseTimeout="30000"/>
	
	<context:property-placeholder location="discoveryenvironment.properties" />
	
	<spring:beans xmlns="http://www.springframework.org/schema/beans">
	
		<bean name="fileUploadedEvent"
			class="org.iplantc.jlrproxytoolkit.factorybean.JLRProxyFactoryBean">
			<property name="interfaces">
				<list><value>org.iplantc.iptol.server.FileUploadedEvent</value></list>
			</property>
			<property name="invocationHandler">
				<bean class="org.iplantc.jlrproxytoolkit.invocationhandler.SendViaMule">
					<property name="endpoint" value="vm://importfile" />
					<property name="synchronous" value="true" />
					<property name="exceptionClass" value="org.iplantc.iptol.server.UploadException" />
				</bean>
			</property>
		</bean>
	
		<bean name="extractNexusFileService"
			class="org.iplantc.phyloparser.NexusParser" />
	
		<bean name="extractNewickFileService"
			class="org.iplantc.phyloparser.NewickParser" />

		<bean name="labelTreeService"
			class="org.iplantc.importfile.phyloparser.LabelTrees" />
		
		<bean name="transformFileDataModel"
			class="org.iplantc.importfile.phyloparser.FileDataCdaoTransformer" />
		
		<bean name="transformTreeDataToTree"
			class="org.iplantc.exporttree.treedata.TreeTransformer" />
		
		<bean name="persistTreeModel"
			class="org.iplantc.importfile.treedata.PersistTreeData">
			<property name="sessionFactory" ref="sessionFactory" />
		</bean>
	
		<bean name="treeService"
			class="org.iplantc.treedata.service.TreeService">
			<property name="sessionFactory" ref="sessionFactory" />
		</bean>

		<bean name="fileService"
			class="org.iplantc.treedata.service.FileService">
			<property name="sessionFactory" ref="sessionFactory" />
		</bean>
		
		<bean name="workspaceService"
			class="org.iplantc.treedata.service.WorkspaceService">
			<property name="sessionFactory" ref="sessionFactory" />
		</bean>
		
		<bean name="dataSource" class="org.apache.commons.dbcp.BasicDataSource" destroy-method="close">
			<property name="driverClassName" value="org.postgresql.Driver" />
			<property name="url" value="jdbc:postgresql://${org.iplantc.discoveryenvironment.database.host}:${org.iplantc.discoveryenvironment.database.port}/${org.iplantc.discoveryenvironment.database.database}" />
			<property name="username" value="${org.iplantc.discoveryenvironment.database.user}" />
			<property name="password" value="${org.iplantc.discoveryenvironment.database.password}" />
		</bean>
	
		<bean name="sessionFactory" class="org.springframework.orm.hibernate3.LocalSessionFactoryBean">
			<property name="dataSource" ref="dataSource" />
			<property name="mappingResources">
				<list>
					<value>database.hbm.xml</value>
				</list>
			</property>
			<property name="hibernateProperties">
				<value>
					hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
					hibernate.hbm2ddl.auto=update
				</value>
			</property>
		</bean>
		
		<bean name="stateStorage" class="org.iplantc.muletoolkit.transformers.state.ThreadLocalStateStorage" />
	
	</spring:beans>

	<custom-transformer name="BuildState" class="org.iplantc.muletoolkit.transformers.state.RestoreState">
		<spring:property name="payloadKeys">
			<spring:list>
				<spring:value>data</spring:value>
				<spring:value>filename</spring:value>
			</spring:list>
		</spring:property>
	</custom-transformer>
	<custom-transformer name="SaveState" class="org.iplantc.muletoolkit.transformers.state.SaveState">
		<spring:property name="stateStorage" ref="stateStorage" />		
	</custom-transformer>
	<custom-transformer name="BuildExtractRequest" class="org.iplantc.muletoolkit.transformers.state.BuildArrayFromState">
		<spring:property name="keys">
			<spring:list>
				<spring:value>data</spring:value>
			</spring:list>
		</spring:property>
	</custom-transformer>
	<custom-transformer name="RestoreState" class="org.iplantc.muletoolkit.transformers.state.RestoreState">
		<spring:property name="stateStorage" ref="stateStorage" />
	</custom-transformer>
	<custom-transformer name="RestoreStateWithFile" class="org.iplantc.muletoolkit.transformers.state.RestoreState">
		<spring:property name="stateStorage" ref="stateStorage" />
		<spring:property name="payloadKeys">
			<spring:list>
				<spring:value>file</spring:value>
			</spring:list>
		</spring:property>
	</custom-transformer>
	<custom-transformer name="BuildLabelTreeRequest" class="org.iplantc.muletoolkit.transformers.state.BuildArrayFromState">
		<spring:property name="keys">
			<spring:list>
				<spring:value>file</spring:value>
				<spring:value>filename</spring:value>
			</spring:list>
		</spring:property>
	</custom-transformer>
	<custom-transformer name="BuildAddFileToWorkspaceRequest" class="org.iplantc.muletoolkit.transformers.state.BuildArrayFromState">
		<spring:property name="keys">
			<spring:list>
				<spring:value type="java.lang.Long">1</spring:value>
				<spring:value>#payload</spring:value>
			</spring:list>
		</spring:property>
	</custom-transformer>
	<custom-transformer name="ExtractTreeInfo" class="org.iplantc.iptol.server.ExtractTreeInfoTransformer" />
	<custom-transformer name="ExtractFileInfo" class="org.iplantc.iptol.server.ExtractFileInfoTransformer" />
	<custom-transformer name="FileToFileInfo" class="org.iplantc.iptol.server.FileToFileInfoTransformer" />
	<custom-transformer name="ExtractWorkspaceInfo" class="org.iplantc.iptol.server.ExtractWorkspaceInfoTransformer" />	
	<custom-transformer name="StringToLong" class="org.iplantc.muletoolkit.transformers.StringToLongTransformer" />
	<custom-transformer name="ComposeChangeTreeLabelRequest" class="org.iplantc.iptol.server.ComposeChangeTreeLabelRequest" />
	<custom-transformer name="DiscardPayload" class="org.iplantc.muletoolkit.transformers.DiscardPayload" />
	<custom-transformer name="SetHttpStatusOnException" class="org.iplantc.muletoolkit.transformers.SetHttpStatusOnException" />
	<json:object-to-json-transformer name="SpitOutJsonTree" excludeProperties="nodes,allNodes,parent" />
	<json:object-to-json-transformer name="SpitOutJsonTreeList" />
	<json:object-to-json-transformer name="SpitOutJsonFile" />
	<json:object-to-json-transformer name="SpitOutJsonFileList" />
	<json:object-to-json-transformer name="SpitOutJsonWorkspace" />
		
	<model>
		<service name="ImportFile">
			<inbound>
				<vm:inbound-endpoint path="importfile" synchronous="true" responseTransformer-refs="ExtractFileInfo" />
				<forwarding-router />
			</inbound>
			<outbound>
				<chaining-router>
					<vm:outbound-endpoint path="extractfile" transformer-refs="BuildState SaveState BuildExtractRequest" responseTransformer-refs="RestoreStateWithFile" />
					<vm:outbound-endpoint path="labeltrees" transformer-refs="BuildLabelTreeRequest" />
					<vm:outbound-endpoint path="transformfiledatamodel" />
					<vm:outbound-endpoint path="persisttreemodel" />
					<vm:outbound-endpoint path="addfiletoworkspace" transformer-refs="SaveState BuildAddFileToWorkspaceRequest" responseTransformer-refs="RestoreState" />
				</chaining-router>
			</outbound>
		</service>
		
		<service name="ExtractFile">
			<inbound>
				<vm:inbound-endpoint path="extractfile" synchronous="true" />
				<forwarding-router />
			</inbound>
			<outbound>
				<exception-based-router>
					<vm:outbound-endpoint path="extractnexusfile" />
					<vm:outbound-endpoint path="extractnewickfile" />
				</exception-based-router>
			</outbound>
		</service>
		
		<service name="ExtractNexusFile">
			<inbound>
				<vm:inbound-endpoint path="extractnexusfile" synchronous="true" />
			</inbound>
			<component>
				<spring-object bean="extractNexusFileService" />
			</component>
		</service>

		<service name="ExtractNewickFile">
			<inbound>
				<vm:inbound-endpoint path="extractnewickfile" synchronous="true" />
			</inbound>
			<component>
				<spring-object bean="extractNewickFileService" />
			</component>
		</service>

		<service name="LabelTrees">
			<inbound>
				<vm:inbound-endpoint path="labeltrees" synchronous="true" />
			</inbound>
			<component>
				<spring-object bean="labelTreeService" />
			</component>
		</service>
		
		<service name="TransformFileDataModel">
			<inbound>
				<vm:inbound-endpoint path="transformfiledatamodel" synchronous="true" />
			</inbound>
			<component>
				<spring-object bean="transformFileDataModel" />
			</component>
		</service>

		<service name="PersistTreeModel">
			<inbound>
				<vm:inbound-endpoint path="persisttreemodel" synchronous="true" />
			</inbound>
			<component>
				<spring-object bean="persistTreeModel" />
			</component>
		</service>
		
		<service name="AddFileToWorkspace">
			<inbound>
				<vm:inbound-endpoint path="addfiletoworkspace" synchronous="true" />
			</inbound>
			<component>
				<method-entry-point-resolver>
					<include-entry-point method="addFileToWorkspace" />
				</method-entry-point-resolver>
				<spring-object bean="workspaceService" />
			</component>
		</service>
		
		<service name="ChangeTreeLabel">
			<inbound>
				<vm:inbound-endpoint path="changetreelabel" synchronous="true" />
			</inbound>
			<component>
				<method-entry-point-resolver>
					<include-entry-point method="updateTreeLabel" />
				</method-entry-point-resolver>
				<spring-object bean="treeService" />
			</component>
		</service>

		<service name="RetrieveTreeData">
			<inbound>
				<vm:inbound-endpoint path="retrievetreedata" synchronous="true" />
			</inbound>
			<component>
				<method-entry-point-resolver>
					<include-entry-point method="retrieveTree" />
				</method-entry-point-resolver>
				<spring-object bean="treeService" />
			</component>
		</service>

		<service name="RetrieveTrees">
			<inbound>
				<vm:inbound-endpoint path="retrievetrees" synchronous="true" />
			</inbound>
			<component>
				<no-arguments-entry-point-resolver>
					<include-entry-point method="retrieveTrees" />
				</no-arguments-entry-point-resolver>
				<spring-object bean="treeService" />
			</component>
		</service>

		<service name="RetrieveWorkspaceData">
			<inbound>
				<vm:inbound-endpoint path="retrieveworkspacedata" synchronous="true" />
			</inbound>
			<component>
				<method-entry-point-resolver>
					<include-entry-point method="retrieveWorkspace" />
				</method-entry-point-resolver>
				<spring-object bean="workspaceService" />
			</component>
		</service>

		<service name="RestfulServices">
			<inbound>
				<http:inbound-endpoint host="localhost" port="14444" synchronous="true" keep-alive="true" />
			</inbound>
			<outbound>
				<filtering-router>
					<vm:outbound-endpoint path="changetreelabel" transformer-refs="ComposeChangeTreeLabelRequest" responseTransformer-refs="SetHttpStatusOnException DiscardPayload" />
					<restlet:uri-template-filter pattern="/trees/{set-property.treeId}/label" verbs="POST" />
				</filtering-router>
				<chaining-router>
					<vm:outbound-endpoint path="retrievetreedata" transformer-refs="StringToLong" />
					<vm:outbound-endpoint path="transformtreedatatotree" responseTransformer-refs="SpitOutJsonTree SetHttpStatusOnException" />
					<restlet:uri-template-filter pattern="/trees/{set-payload.treeId}" />
				</chaining-router>
				<filtering-router>
					<vm:outbound-endpoint path="retrievetrees" responseTransformer-refs="ExtractTreeInfo SpitOutJsonTreeList SetHttpStatusOnException" />
					<restlet:uri-template-filter pattern="/trees" />
				</filtering-router>
				<filtering-router>
					<vm:outbound-endpoint path="retrievefiledata" 
						transformer-refs="StringToLong" 
						responseTransformer-refs="FileToFileInfo SpitOutJsonFile SetHttpStatusOnException" />
					<restlet:uri-template-filter pattern="/files/{set-payload.fileId}" />
				</filtering-router>
				<filtering-router>
					<vm:outbound-endpoint path="retrievefiles" 
						responseTransformer-refs="ExtractFileInfo SpitOutJsonFileList SetHttpStatusOnException" />
					<restlet:uri-template-filter pattern="/files" />
				</filtering-router>
	 			<filtering-router>
					<vm:outbound-endpoint path="retrieveworkspacedata"
						transformer-refs="StringToLong"
						responseTransformer-refs="ExtractWorkspaceInfo SpitOutJsonWorkspace SetHttpStatusOnException" />
					<restlet:uri-template-filter pattern="/workspace/{set-payload.workspaceId}" />
				</filtering-router>
<!-- 			<filtering-router>
					<vm:outbound-endpoint path="retrieveworkspace" 
						responseTransformer-refs="ExtractFileInfo SpitOutJsonTreeList" />
					<restlet:uri-template-filter pattern="/workspace" />
				</filtering-router> -->
			</outbound>
		</service>

		<service name="TransformTreeDataToTree">
			<inbound>
				<vm:inbound-endpoint path="transformtreedatatotree" synchronous="true" />
			</inbound>
			<component>
				<spring-object bean="transformTreeDataToTree" />
			</component>
		</service>
		
		<service name="RetrieveFileData">
			<inbound>
				<vm:inbound-endpoint path="retrievefiledata" synchronous="true" />
			</inbound>
			<component>
				<method-entry-point-resolver>
					<include-entry-point method="retrieveFile" />
				</method-entry-point-resolver>
				<spring-object bean="fileService" />
			</component>
		</service>

		<service name="RetrieveFiles">
			<inbound>
				<vm:inbound-endpoint path="retrievefiles" synchronous="true" />
			</inbound>
			<component>
				<no-arguments-entry-point-resolver>
					<include-entry-point method="retrieveFiles" />
				</no-arguments-entry-point-resolver>
				<spring-object bean="fileService" />
			</component>
		</service>

	</model>

</mule>
